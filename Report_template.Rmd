---
title: "ST_518 Project"
author: "MA, HK, BA, JF"
date: "`r Sys.Date()`"
output: 
  pdf_document
---

```{r,  echo = FALSE, message = FALSE, error = FALSE}
library(tidyverse)
library(emmeans)
library(lme4)
library(lmerTest)
library(olsrr)
library(car)
df_eff <- read_csv('effervescence.csv', col_types = 'fffnnn')
```

\newpage

## Executive Summary

Text goes here.....

\newpage

## Introduction

### Experimental Design

Description here

### Exploratory Data Analysis

For this study we are presented with data from an 'Effervescent Experiment'. The data contained dissolving times of two different brands of cold medicine tablets that were obtained under various conditions. Those conditions included varying water temperatures (6$^\circ$C, 23$^\circ$C, 40$^\circ$C) and the presence of stirring (magnetic stir bar at 350 rpm). This was a complete block design with stirring acting as the blocking effect. In all, the data contained 48 rows and 6 columns. The 6 columns include 3 explanatory variables (Brand, Temp, Stirred categorical factors), 2 response variables (Time and Org Time, both numerical) and 1 descriptor (sample order). Prior to starting any analysis, we will explore the data to gain an understanding of what to expect and to check for violations of any assumptions.

```{r, echo=FALSE, message=FALSE, error=FALSE}
df_stats <-
df_eff %>% group_by(Brand, Temp, Stirred) %>% 
summarise('25%' = quantile(Time, probs = 0.25),
          'Mean' = mean(Time), 
          'Median' = median(Time),
          '75%' = quantile(Time, probs = 0.75),
          'Var' = var(Time), 
          'n' = n())

knitr::kable(df_stats)
```

From the summary statistics table, we can see that each group has exactly 4 entries, so no imbalance concerns. The variance seems to jump by quite a large amount between the groups, so contrast analysis might be a concern due to the small sample size. 

```{r,  echo=FALSE, message=FALSE, error=FALSE, fig.dim=c(7,3), dpi=300}
df_eff %>% ggplot() + geom_boxplot(aes(fill = Brand, y = Time, x = Temp)) + 
  facet_grid(cols = vars(Stirred)) + labs(title = "Stirred") + theme(
  plot.title = element_text(hjust = 0.5)
)
```

Immediately it can be seen that stirring seems to increase the variance of the name brand medicine. Also, an interaction effect between temperature and brand can be deduced if lines are drawn through the centers of the boxes. We can also see that temperature has an inverse effect on dissolving times whether stirring is present or not. Stirring might have an additive effect regardless of temperature. 

```{r, echo=FALSE, message=FALSE, error=FALSE, fig.dim=c(7,3), dpi=250}
##3 factor interaction plot based on HW7 code
par(mfrow=c(1,2), mar = c(3.5,3.5,2,2))
with(df_eff%>%filter(Stirred=="yes"),interaction.plot(Temp,Brand,Time,
            type="b", pch=19, col=c(2,4), ylab="", xlab = "",
            main="Mean Time vs. Temp: Stirred = Yes", 
            cex.main = 0.75, legend = FALSE))
legend("topright",
       title = "Brand",
       c("Name", "Store"),
       cex = 0.7,
       col = c("#DF536B","#2297E6"),
       pch = c(19,19), lty = c(2,1))
title(xlab = "Temperature", ylab = "Mean Dissolving Time (Minutes)", line = 2.25, cex.lab = 0.9)
#```

#```{r, echo=FALSE, message=FALSE, error=FALSE, fig.dim=c(6,3), dpi=250}
with(df_eff%>%filter(Stirred=="no"),interaction.plot(Temp,Brand,Time,
          type="b", pch=19, col=c(2,4), ylab="", xlab = "",
          main="Mean Time vs. Temp: Stirred = No", 
          cex.main = 0.75, legend = FALSE))
legend("topright",
       title = "Brand",
       c("Name", "Store"),
       cex = 0.7,
       col = c("#DF536B","#2297E6"),
       pch = c(19,19), lty = c(2,1))
title(xlab = 'Temperature', ylab = "Mean Dissolving Time (Minutes)", line = 2.25, cex.lab = 0.9)
```

The possible interaction between brand and temperature becomes even more noticeable in the preceding three factor interaction plots.  Specifically the brand and temperature interaction can be seen with increasing temperature the store brand line has a more negative slope than the name brand line.  In addition, there might be a slight three factor interaction between brand, temperature, and stirring as the name and store brand lines appear to be closer together in the stirred=yes plot than the stirred=no plot.  


```{r, echo=FALSE, message=FALSE, error=FALSE, fig.dim=c(7,3), dpi=250}
aov_eff <- aov(lm_eff <- lm(Time ~ Brand * Temp * Stirred, data = df_eff))

#cooksD_values <- cooks.distance(lm_eff)
 
#ggplot() + geom_col(aes(y = cooksD_values, x = 1:length(cooksD_values)), width = 0.025, col = 'red')  + 
#    geom_point(aes(y = cooksD_values, x = 1:length(cooksD_values))) + xlab('Sample Points') + ylab("Cook's Distance") + 
#    geom_hline(yintercept = 0.25, lty = 2) + labs(title = "Cook's Distance for each sample point")
```

```{r, echo=FALSE, message=FALSE, error=FALSE, fig.dim=c(7,3), dpi=250}
ols_plot_cooksd_chart(lm_eff)
```

From the boxplots, we were able to see a small amount of outliers. To confirm if there are any of concern we plotted the Cook's Distance for each point based on a full linear model. Point 8 has a higher Cook's distance than the rest of the points which may require removal for analysis if it is suspected of causing issues in the analysis. This would have to be weighed against the risks cause by introducing imbalances. 

```{r, echo=FALSE, message=FALSE, error=FALSE, fig.dim=c(6,3), dpi=250}
qqnorm(lm_eff$resid, pch = 20)
qqline(lm_eff$resid, col = "maroon", lwd = 2)
```

Finally, we check the normality of the data. Here a QQ plot is generated for the full model residuals. The data seems to be indicative of heavy tails. This might pose a problem for some of our analyses.

\newpage


## Analysis and Results

### Contrasts

```{r, echo = FALSE, message = FALSE, error = FALSE}
means_eff <- emmeans(aov_eff, specs = c('Brand', 'Temp', 'Stirred'))
#summary(means_eff)
```

```{r, echo = FALSE, message = FALSE, error = FALSE}
cont_str_brd <-
contrast(means_eff, list(stirred = c(1/6, 1/6, 1/6, 1/6, 1/6, 1/6, -1/6, -1/6, -1/6, -1/6, -1/6, -1/6),
                         branding = rep(c(1/6,-1/6), 6)
                         )
         )

cont_strbrd <-

contrast(means_eff, list(stirredbrand = c(1/3, 0,  1/3, 0, 1/3, 0, -1/3, 0, -1/3, 0, -1/3, 0),
                         stirredstore = c(0, 1/3, 0,  1/3, 0, 1/3, 0, -1/3, 0, -1/3, 0, -1/3)
                         )
         )
cont_temp <- 
contrast(means_eff, list(temp6_23 = c(1/4, 1/4, -1/4, -1/4, 0, 0, 1/4, 1/4, -1/4, -1/4, 0, 0),
                         temp6_40 = c(1/4, 1/4, 0, 0, -1/4, -1/4, 1/4, 1/4, 0, 0, -1/4, -1/4),
                         temp23_40 = c(0, 0, 1/4, 1/4, -1/4, -1/4, 0, 0, 1/4, 1/4, -1/4, -1/4)
                         ), options=list(adjust="bonferroni"))
knitr::kable(confint(cont_str_brd))
knitr::kable(confint(cont_strbrd))
knitr::kable(confint(cont_temp))
```

Conducting a linear contrast analysis on each of the explanatory variables reveals that there are significant differences between groups based on factors. In the first case, we contrasted the means of stirred versus not stirred. Here the difference in means is -2.41 with an upper 95% confidence limit of -3.04 and a lower 95% CI limit of -1.78. In other words, on average stirring medicine reduces dissolving time by between 3.04 and 1.78 minutes regardless of brand or temperature. When looking only at brand, name brand dissolving times were on average between 4.71 and 5.97 (95% CI) minutes slower than store brand. Since neither of the intervals contained zero we can conclude that there is a difference between brands and between the presence of stirring.

While significant for both store and name brands, stirring had more of an impact to dissolving times for name brand than it did for the store brand. Stirring reduced name brand dissolving times by 2.83 and 4.61 minutes whereas for the store brand that interval was 0.22 and 2 minutes.

A similar analysis was completed on the three levels of temperature........ 

\newpage
### Model Development

Three models were developed and analyzed for this paper:

$Model~1: Y_{ijkl} = \mu + \alpha_i + \beta_j + \gamma_k + (\alpha \beta)_{ij} + (\alpha \gamma)_{ik} + (\gamma \beta)_{jk} + (\alpha \beta \gamma)_{ijk} + \epsilon_{ijkl}$  
$Model~2: Y_{ijkl} = \mu + \alpha_i + \beta_j + \gamma_k + (\alpha \beta)_{ij} + \epsilon_{ijkl}$  
$Model~3: Y_{ijkl} = \mu + \alpha_i + \beta_j + \gamma_k + \epsilon_{ijkl}$  

Where $\alpha$ is brand effect, $\beta$ is temperature effect, $\gamma$ is stir effect. i, j, k are `r 1:2`, `r 1:3`, and `r 1:2`, respectively. $\epsilon_{ijkl}$ is assumed to be normally distributed with a $\mu$ of 0 and a variance of $\sigma^2_\epsilon$. $\mu$ is the overall mean and is an unknown value.  

```{r, echo = FALSE, message = FALSE, error = FALSE}
par(mfrow=c(2,2), mar = c(5,5,2,2))
plot(aov_eff)
knitr::kable(summary(aov_eff)[[1]], 'simple', caption = 'Model 1 ANOVA Results')
```

```{r,  echo = FALSE, message = FALSE, error = FALSE}
#model with stirred as block effect without interaction 
aov_block_eff <- aov(lm_block_eff <- lm(Time ~ Brand * Temp + Stirred, data = df_eff))
#summary(lm_block_eff)
knitr::kable(summary(aov_block_eff)[[1]], caption = "Model 2: ANOVA Table")
par(mfrow=c(2,2), mar = c(5,5,2,2))
plot(aov_block_eff)
ols_plot_cooksd_chart(lm_block_eff)
```

```{r,  echo = FALSE, message = FALSE, error = FALSE}
#added covariate Order model with stirred as block effect without interaction 
aov_block_order_eff <- aov(lm_block_order_eff <- lm(Time ~ Brand * Temp + Stirred + Order, data = df_eff))
#summary(lm_block_order_eff)
knitr::kable(summary(aov_block_order_eff)[[1]], caption = "Model 3: ANOVA Table")
Anova(aov_block_order_eff, type=3) # type 3 SS
par(mfrow=c(2,2), mar = c(5,5,2,2))
plot(lm_block_order_eff)
ols_plot_cooksd_chart(lm_block_order_eff)
#added covariate Order to model with 3 factor interaction
```


```{r,  echo = FALSE, message = FALSE, error = FALSE}
aov_three_order_eff <- aov(lm_three_order_eff <- lm(Time ~ Brand * Temp * Stirred + Order, data = df_eff))
#summary(lm_three_order_eff)
knitr::kable(summary(aov_three_order_eff)[[1]], 'simple', caption = "Model 4 ANOVA Table")
Anova(aov_three_order_eff, type=3) # type 3 SS
par(mfrow=c(2,2), mar = c(5,5,2,2))
plot(lm_three_order_eff)
```

### Model Selection

### Results

## Conclusion

\newpage

## Appendix: Code
```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```